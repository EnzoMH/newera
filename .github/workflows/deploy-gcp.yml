name: Deploy to Google Cloud VM

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  VM_NAME: semiconductor-rag-vm
  VM_ZONE: asia-northeast3-a # 서울 리전
  IMAGE_NAME: semiconductor-rag
  REGISTRY: gcr.io

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker

      - name: Build Docker image
        run: |
          docker build -t $REGISTRY/$PROJECT_ID/$IMAGE_NAME:$GITHUB_SHA \
                       -t $REGISTRY/$PROJECT_ID/$IMAGE_NAME:latest \
                       --build-arg CUDA_VERSION=12.6.0 \
                       .

      - name: Push to Google Container Registry
        run: |
          docker push $REGISTRY/$PROJECT_ID/$IMAGE_NAME:$GITHUB_SHA
          docker push $REGISTRY/$PROJECT_ID/$IMAGE_NAME:latest

      - name: Create GCP VM with GPU (if not exists)
        run: |
          if ! gcloud compute instances describe $VM_NAME --zone=$VM_ZONE &> /dev/null; then
            gcloud compute instances create $VM_NAME \
              --zone=$VM_ZONE \
              --machine-type=n1-standard-4 \
              --accelerator=type=nvidia-tesla-t4,count=1 \
              --image-family=pytorch-latest-gpu \
              --image-project=deeplearning-platform-release \
              --boot-disk-size=100GB \
              --boot-disk-type=pd-ssd \
              --maintenance-policy=TERMINATE \
              --metadata="install-nvidia-driver=True" \
              --scopes=cloud-platform \
              --tags=http-server,https-server
            
            echo "Waiting for VM to be ready..."
            sleep 60
          fi

      - name: Deploy to VM
        run: |
          gcloud compute ssh $VM_NAME --zone=$VM_ZONE --command="
            # Docker 설치 확인
            if ! command -v docker &> /dev/null; then
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker \$USER
            fi
            
            # NVIDIA Container Toolkit 설치
            if ! command -v nvidia-container-toolkit &> /dev/null; then
              distribution=\$(. /etc/os-release;echo \$ID\$VERSION_ID)
              curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
              curl -s -L https://nvidia.github.io/nvidia-docker/\$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
              sudo apt-get update
              sudo apt-get install -y nvidia-container-toolkit
              sudo systemctl restart docker
            fi
            
            # 기존 컨테이너 중지 및 제거
            docker stop semiconductor-rag || true
            docker rm semiconductor-rag || true
            
            # 최신 이미지 pull
            gcloud auth configure-docker
            docker pull $REGISTRY/$PROJECT_ID/$IMAGE_NAME:latest
            
            # 컨테이너 실행
            docker run -d \
              --name semiconductor-rag \
              --restart unless-stopped \
              --runtime=nvidia \
              --gpus all \
              -p 8001:8001 \
              -e MONGODB_URI=${{ secrets.MONGODB_URI }} \
              -e GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }} \
              -e GEMINI_MODEL=gemini-2.5-pro \
              -v /data/semiconductor-rag:/app/data \
              $REGISTRY/$PROJECT_ID/$IMAGE_NAME:latest
            
            # 로그 확인
            sleep 10
            docker logs semiconductor-rag
          "

      - name: Configure firewall rules
        run: |
          if ! gcloud compute firewall-rules describe allow-rag-app &> /dev/null; then
            gcloud compute firewall-rules create allow-rag-app \
              --allow tcp:8001 \
              --source-ranges 0.0.0.0/0 \
              --target-tags http-server \
              --description "Allow RAG application traffic"
          fi

      - name: Get VM External IP
        run: |
          EXTERNAL_IP=$(gcloud compute instances describe $VM_NAME \
            --zone=$VM_ZONE \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')

          echo "=========================================="
          echo "Deployment Complete!"
          echo "=========================================="
          echo "RAG Application URL: http://$EXTERNAL_IP:8001"
          echo "Health Check: http://$EXTERNAL_IP:8001/health"
          echo "=========================================="
